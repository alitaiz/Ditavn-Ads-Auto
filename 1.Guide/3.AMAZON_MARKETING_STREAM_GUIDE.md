# Hướng dẫn Tích hợp Amazon Marketing Stream với PostgreSQL (Phương pháp API Endpoint tiết kiệm)

## Mục tiêu

Tài liệu này hướng dẫn bạn cách thiết lập một pipeline dữ liệu **hybrid**, **chi phí cực thấp** để nhận, xử lý và ghi dữ liệu từ Amazon Marketing Stream vào cơ sở dữ liệu **PostgreSQL** đang chạy trên VPS Ubuntu 22.04.

> **Lưu ý về Lựa chọn Dataset:** Hướng dẫn này sử dụng đồng thời các dataset `sp-traffic`, `sp-conversion`, `sb-traffic`, `sb-conversion`, `sd-traffic` và `sd-conversion` để có được một dashboard PPC toàn diện.

---

## Tổng quan Kiến trúc Hybrid (Chi phí thấp)

**Luồng Ghi dữ liệu (Data Ingestion):**
`Amazon Ads API` → `AWS Kinesis Data Firehose` → `AWS Lambda (ditavn-process-and-forward-stream)` → `Internet (HTTPS)` → `Backend API (trên VPS)` → `PostgreSQL (trên VPS)`

---

## Phân tích Chi phí (Cost Analysis)

-   **Kinesis Data Firehose:** Rất thấp, ~$0.029/GB.
-   **AWS Lambda:** Gói miễn phí lớn, chi phí gần như **$0/tháng**.
-   **VPS Ubuntu:** Chi phí không đổi.

**Tổng chi phí ước tính trên AWS: ~$0-2/tháng.**

---

## Yêu cầu

1.  **Tài khoản AWS & AWS CLI.**
2.  **VPS Ubuntu 22.04** với PostgreSQL và backend Node.js/Express đang chạy.
3.  **Một tên miền** trỏ đến IP của VPS và đã được cài đặt SSL (HTTPS).
4.  **Quyền Admin trên Amazon Ads.**

---

## Phần 1: Cấu hình VPS và Backend API

### Bước 1: Tạo và Cấp quyền cho Bảng Dữ liệu Stream
Bảng này sẽ lưu trữ dữ liệu thô nhận được từ Lambda. 

1.  **Đăng nhập vào VPS của bạn qua SSH.**
2.  **Kết nối vào PostgreSQL:** Chạy lệnh sau để kết nối trực tiếp vào database `amazon_data_ditavn` với quyền quản trị:
    ```bash
    sudo -u postgres psql -d amazon_data_ditavn
    ```
3.  **Chạy lệnh SQL tạo bảng và cấp quyền:** Sao chép và dán toàn bộ nội dung SQL bên dưới.
    ```sql
    -- Bảng lưu trữ dữ liệu stream thô từ Amazon Marketing Stream
    CREATE TABLE IF NOT EXISTS raw_stream_events (
        id SERIAL PRIMARY KEY,
        event_type TEXT,
        event_data JSONB,
        received_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Tạo chỉ mục để tăng tốc độ truy vấn
    CREATE INDEX IF NOT EXISTS idx_rse_received_at ON raw_stream_events (received_at DESC);
    CREATE INDEX IF NOT EXISTS idx_rse_event_type ON raw_stream_events (event_type);

    -- Cấp quyền cho user 'ditavn' của ứng dụng
    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE raw_stream_events TO ditavn;
    GRANT USAGE, SELECT ON SEQUENCE raw_stream_events_id_seq TO ditavn;
    ```
4.  **Thoát khỏi PostgreSQL:** Gõ lệnh `\q` và nhấn Enter.

### Bước 2: Cập nhật Backend để Nhận Dữ liệu Stream

#### 2A. Cập nhật `backend/.env`
- Mở file `backend/.env` và thêm một biến môi trường mới.
- **QUAN TRỌNG:** Tự tạo một chuỗi ký tự ngẫu nhiên, dài và phức tạp cho giá trị này. Đây là "chìa khóa bí mật" để Lambda có thể gửi dữ liệu đến backend của bạn một cách an toàn.
```dotenv
# Thêm dòng này vào cuối file backend/.env
STREAM_INGEST_SECRET_KEY=your_super_long_and_secret_random_string_here
```

#### 2B. Khởi động lại Backend
Nếu bạn đang dùng `pm2` trên VPS, hãy khởi động lại ứng dụng backend để áp dụng các thay đổi:
```sh
pm2 restart ppc-auto-backend-ditavn
```

---

## Phần 2: Thiết lập Pipeline trên AWS

### Bước 3: AWS - Tạo IAM Role cho Lambda
1.  Mở dịch vụ **IAM** -> **Roles** -> **"Create role"**.
2.  **Trusted entity type:** Chọn **AWS service**, Use case: **Lambda**.
3.  **Add permissions:** Tìm và thêm policy `AWSLambdaBasicExecutionRole`.
4.  **Role name:** `Ditavn-Lambda-StreamForwarder-Role` (Thêm `Ditavn-` để phân biệt).
5.  Nhấp **"Create role"**.

### Bước 4: AWS - Tạo Lambda Function
1.  Mở dịch vụ **Lambda** -> **"Create function"**.
2.  **Function name:** `ditavn-process-and-forward-stream` (Thêm `ditavn-` để phân biệt).
3.  **Runtime:** **Node.js 20.x**.
4.  **Permissions:** Chọn **"Use an existing role"** và chọn `Ditavn-Lambda-StreamForwarder-Role` bạn vừa tạo.
5.  Nhấp **"Create function"**.
6.  Trong tab **Code source**, dán toàn bộ nội dung từ file `lambda_deployment_package/process-and-forward-stream.mjs.txt` vào file `index.mjs`.
7.  Trong tab **Configuration** -> **Environment variables**, thêm 2 biến sau:
    -   Key: `INGEST_API_URL`, Value: `https://ditavn.tababyco.com/api/stream-ingest`.
    -   Key: `INGEST_API_KEY`, Value: Dán chuỗi bí mật bạn đã tạo ở **Bước 2A**.
8.  Trong **General configuration**, tăng **Timeout** lên `1 minute`.
9.  Nhấp **"Deploy Changes"**.

### Bước 5: AWS - Tạo và Cấu hình Kinesis Data Firehose
Đây là bước tạo luồng dữ liệu sẽ nhận sự kiện từ Amazon và chuyển chúng đến Lambda function của bạn.

1.  Mở dịch vụ **Amazon Kinesis** trong AWS Console.
2.  Trong menu bên trái, chọn **"Data Firehose"**.
3.  Nhấp vào **"Create delivery stream"**.
4.  **Source:** Chọn **"Direct PUT"**.
5.  **Destination:** Chọn **"AWS Lambda"**.
6.  **Delivery stream name:** Nhập tên cho luồng của bạn, ví dụ: `ditavn-amazon-ads-stream`.
7.  Trong phần **"Transform records"**:
    -   Bật **"Data transformation"**.
    -   Trong **"Lambda function"**, chọn function bạn đã tạo ở Bước 4: `ditavn-process-and-forward-stream`.
8.  Trong phần **"Backup settings"**, chọn **"Failed data only"** và chọn một S3 bucket để lưu trữ các bản ghi lỗi. Bạn có thể tạo một bucket mới nếu cần (ví dụ: `ditavn-firehose-error-logs-[random_string]`).
9.  Xem lại cấu hình và nhấp **"Create delivery stream"**.
10. **QUAN TRỌNG:** Sau khi tạo xong, hãy sao chép lại **ARN** của delivery stream này. Nó sẽ trông giống như `arn:aws:firehose:us-east-1:123456789012:deliverystream/ditavn-amazon-ads-stream`.

---

## Phần 3: Đăng ký Stream và Hoàn tất

### Bước 6: Tạo IAM Roles cho Amazon Ads
Để Amazon Ads có quyền gửi dữ liệu vào Firehose của bạn, bạn cần tạo hai IAM Role đặc biệt.

#### 6A. Tạo `subscriberRole` (Quyền Ghi vào Firehose)
Role này cho phép Amazon ghi dữ liệu.
1.  Mở dịch vụ **IAM** -> **Roles** -> **"Create role"**.
2.  **Trusted entity type:** Chọn **"Custom trust policy"** và dán JSON sau:
    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Principal": {
                    "Service": "streams.amazon.com"
                },
                "Action": "sts:AssumeRole"
            }
        ]
    }
    ```
3.  **Permissions:** Nhấp **"Create policy"** (mở trong tab mới).
    -   Chuyển sang tab **JSON**.
    -   Dán policy sau, **nhớ thay thế ARN của Firehose bạn đã tạo ở Bước 5**:
        ```json
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": [
                        "firehose:PutRecord",
                        "firehose:PutRecordBatch"
                    ],
                    "Resource": "ARN_CỦA_FIREHOSE_STREAM_CỦA_BẠN"
                }
            ]
        }
        ```
    -   Đặt tên cho policy (ví dụ: `Ditavn-FirehoseWriteAccess`) và tạo nó.
    -   Quay lại tab tạo Role, làm mới danh sách policy và chọn policy bạn vừa tạo.
4.  **Role name:** `Ditavn-FirehoseSubscriberRole`.
5.  Tạo Role và sao chép lại **ARN** của nó.

#### 6B. Tạo `subscriptionRole` (Quyền Ủy quyền)
Role này cho phép Amazon sử dụng (pass) `subscriberRole`.
1.  Làm theo các bước 1-2 như trên với cùng **Custom trust policy**.
2.  **Permissions:** Nhấp **"Create policy"** (mở trong tab mới).
    -   Chuyển sang tab **JSON**.
    -   Dán policy sau, **nhớ thay thế ARN của `subscriberRole` bạn đã tạo ở bước 6A**:
        ```json
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": "iam:PassRole",
                    "Resource": "ARN_CỦA_SUBSCRIBER_ROLE_BẠN_VỪA_TẠO"
                }
            ]
        }
        ```
    -   Đặt tên cho policy (ví dụ: `Ditavn-FirehosePassRoleAccess`) và tạo nó.
    -   Quay lại tab tạo Role, làm mới và chọn policy bạn vừa tạo.
4.  **Role name:** `Ditavn-FirehoseSubscriptionRole`.
5.  Tạo Role và sao chép lại **ARN** của nó.

### Bước 7: Cập nhật file .env và Đăng ký Stream
1.  Mở file `backend/.env` trên VPS của bạn.
2.  Điền các giá trị ARN bạn vừa sao chép:
    ```dotenv
    ADS_API_FIREHOSE_ARN=... (ARN từ Bước 5)
    ADS_API_FIREHOSE_SUBSCRIPTION_ROLE_ARN=... (ARN từ Bước 6B)
    ADS_API_FIREHOSE_SUBSCRIBER_ROLE_ARN=... (ARN từ Bước 6A)
    ```
3.  Lưu file.
4.  Chạy script để đăng ký:
    ```bash
    cd /var/www/Ditavn-Ads-Auto
    npm run stream:subscribe
    ```

### Bước 8: Kiểm tra
Sau khi đăng ký thành công, dữ liệu sẽ bắt đầu chảy.
- **Trên AWS:** Kiểm tra CloudWatch logs của Lambda `ditavn-process-and-forward-stream` để xem các thông báo "Successfully forwarded".
- **Trên VPS:** Kiểm tra logs của ứng dụng backend (`pm2 logs ppc-auto-backend-ditavn`) để xem các thông báo "Successfully ingested".
- **Trong Database:** Truy vấn bảng `raw_stream_events` để thấy dữ liệu mới được thêm vào.

Chúc mừng! Bạn đã thiết lập thành công pipeline để đưa dữ liệu Marketing Stream vào PostgreSQL trên VPS của mình một cách hiệu quả và tiết kiệm chi phí.