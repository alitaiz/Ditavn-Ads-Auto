# Hướng Dẫn (Bảo mật): Kích hoạt HTTPS Miễn phí với Let's Encrypt & Certbot

## Giới thiệu

Hướng dẫn này sẽ chỉ cho bạn cách cài đặt một chứng chỉ SSL/TLS miễn phí từ Let's Encrypt bằng công cụ Certbot. Việc này sẽ kích hoạt HTTPS (kết nối an toàn `https://`), giúp mã hóa toàn bộ dữ liệu giữa người dùng và server của bạn.

**Ưu điểm:**
-   **Miễn phí và Tự động:** Certbot tự động hóa toàn bộ quá trình lấy và gia hạn chứng chỉ.
-   **Bảo mật Tối đa:** Kích hoạt mã hóa HTTPS (biểu tượng ổ khóa trên trình duyệt).
-   **Yêu cầu Bắt buộc:** Cần thiết để các dịch vụ bên ngoài như AWS Lambda có thể giao tiếp an toàn với API endpoint của bạn.

---

## Yêu cầu

-   Bạn đã có một VPS Ubuntu 22.04 với Nginx đang chạy.
-   Bạn đã có một tên miền (ví dụ: `ditavn.tababyco.com`) trỏ đến địa chỉ IP công khai của VPS.

---

## Các bước Thực hiện

### Bước 1: Cài đặt Certbot

Certbot được khuyến nghị cài đặt qua `snapd`, một hệ thống quản lý gói hiện đại.

1.  Đảm bảo `snapd` được cập nhật:
    ```bash
    sudo snap install core; sudo snap refresh core
    ```
2.  Xóa các phiên bản Certbot cũ (nếu có) để tránh xung đột:
    ```bash
    sudo apt-get remove certbot
    ```
3.  Cài đặt Certbot bằng snap:
    ```bash
    sudo snap install --classic certbot
    ```
4.  Tạo một liên kết tượng trưng để lệnh `certbot` có thể được chạy từ bất kỳ đâu:
    ```bash
    sudo ln -s /snap/bin/certbot /usr/bin/certbot
    ```

### Bước 2: Chuẩn bị Cấu hình Nginx cho Certbot

**Đây là bước cực kỳ quan trọng.** Để Certbot hoạt động, nó cần tìm thấy một file cấu hình Nginx **đơn giản chỉ có HTTP** cho tên miền của bạn.

1.  **Mở file cấu hình Nginx của bạn:**
    ```bash
    sudo nano /etc/nginx/sites-available/ditavn.tababyco.com
    ```
2.  **Đảm bảo nội dung file khớp với file mẫu:**
    -   Xóa toàn bộ nội dung hiện có trong file.
    -   Sao chép và dán toàn bộ nội dung từ file `nginx_config_example.txt`.
    -   File này chứa một cấu hình `server` cơ bản lắng nghe trên cổng 80 (HTTP).
3.  **Kiểm tra và khởi động lại Nginx:**
    ```bash
    sudo nginx -t
    ```
    -   Lệnh này phải báo `syntax is ok`. Nếu có lỗi, hãy kiểm tra lại nội dung bạn vừa dán.
    ```bash
    sudo systemctl restart nginx
    ```
    -   Sau bước này, Nginx của bạn đã sẵn sàng để Certbot làm việc.

### Bước 3: Lấy Chứng chỉ SSL và Cấu hình Nginx Tự động

Đây là bước kỳ diệu. Certbot sẽ tự động giao tiếp với Let's Encrypt, lấy chứng chỉ và **tự động chỉnh sửa file cấu hình Nginx** cho bạn.

1.  Chạy lệnh sau:
    ```bash
    sudo certbot --nginx
    ```
2.  **Certbot sẽ hỏi bạn một vài câu:**
    -   **Email address:** Nhập địa chỉ email của bạn. Dùng để gửi thông báo khi chứng chỉ sắp hết hạn.
    -   **Terms of Service:** Gõ `A` và Enter để đồng ý.
    -   **Mailing list:** Gõ `Y` hoặc `N` tùy bạn.
    -   **Which names would you like to activate HTTPS for?:** Certbot sẽ hiển thị danh sách các tên miền nó tìm thấy trong Nginx (ví dụ: `ditavn.tababyco.com`). Nhấn `Enter` để xác nhận.

3.  **Kết quả:** Certbot sẽ hoàn tất quá trình xác thực và cấu hình lại Nginx để sử dụng chứng chỉ mới. Nó cũng sẽ tự động thiết lập chuyển hướng (redirect) từ HTTP sang HTTPS.

### Bước 4: Kiểm tra Gia hạn Tự động

Gói Certbot bạn đã cài đặt sẽ tự động tạo một cron job hoặc systemd timer để kiểm tra và gia hạn chứng chỉ 60 ngày một lần. Bạn không cần làm gì thêm, nhưng có thể kiểm tra xem nó có hoạt động không.

1.  Chạy lệnh kiểm tra gia hạn (không thực sự gia hạn, chỉ mô phỏng):
    ```bash
    sudo certbot renew --dry-run
    ```
    -   Nếu không có lỗi, bạn đã sẵn sàng.

---

## Hoàn tất và Bước tiếp theo

Chúc mừng! Trang web của bạn hiện đã được bảo vệ hoàn toàn bằng HTTPS. Bạn có thể truy cập trang web của mình qua `https://ditavn.tababyco.com` và bạn sẽ thấy biểu tượng ổ khóa an toàn trên trình duyệt.

**Bước tiếp theo:**
Bây giờ HTTPS đã hoạt động, hãy tiếp tục với việc thêm một lớp mật khẩu bảo vệ.
-   **Tiếp tục với Hướng dẫn 5:** `5.SECURITY_NGINX_BASIC_AUTH_GUIDE.md`
