# Hướng dẫn Tích hợp LangChain & LangGraph cho Phân tích PPC Nâng cao

## 1. Mục tiêu

Tài liệu này mô tả cách **LangChain** và **LangGraph** đã được tích hợp vào tính năng "AI Suggester" để tạo ra một hệ thống phân tích và đề xuất tự động hóa thông minh, linh hoạt và mạnh mẽ hơn.

-   **Mục tiêu Hiện tại:** Nâng cấp tính năng đề xuất rule, cho phép AI tự truy vấn và phân tích dữ liệu hiệu suất để đưa ra các đề xuất chính xác và có cơ sở dữ liệu hơn.
-   **Mục tiêu Tương lai:** Mở rộng khả năng của AI để tự động tạo ra các báo cáo phân tích sản phẩm hàng tuần, xác định các xu hướng, và đề xuất các chiến lược PPC toàn diện.

---

## 2. Tại sao lại là LangChain & LangGraph?

-   **LangChain:** Là một framework mạnh mẽ giúp đơn giản hóa việc xây dựng các ứng dụng dựa trên mô hình ngôn ngữ lớn (LLM). Nó cho phép chúng ta "xâu chuỗi" các lệnh gọi LLM với các **"Công cụ" (Tools)**, chẳng hạn như khả năng truy vấn cơ sở dữ liệu hoặc gọi các API bên ngoài. Điều này cho phép LLM không chỉ "suy nghĩ" mà còn có thể "hành động".
-   **LangGraph:** Là một phần mở rộng của LangChain, cho phép xây dựng các **agent** (tác tử) phức tạp, có trạng thái và có thể hoạt động theo chu trình. Thay vì một chuỗi A → B → C đơn giản, LangGraph cho phép agent tự quyết định hành động tiếp theo dựa trên kết quả của bước trước đó. Điều này rất lý tưởng để xây dựng một quy trình phân tích tự động, nơi agent có thể tự thu thập dữ liệu, phân tích, và sau đó quyết định xem có cần thêm dữ liệu hay không trước khi đưa ra kết quả cuối cùng.

---

## 3. Tổng quan Kiến trúc

Luồng hoạt động mới là một quy trình agentic (dựa trên tác tử):

`Frontend (UI)` → `Backend API` → `LangGraph Agent` → `Sử dụng Tools` → `LLM (Gemini)` → `Trích xuất & Định dạng Kết quả` → `Backend API` → `Frontend (UI)`

**Các "Công cụ" (Tools) mà Agent đã được trang bị:**
1.  **Financials Tool:** Một công cụ để tính toán các chỉ số tài chính quan trọng như Lợi nhuận/sản phẩm và ACoS Hòa vốn dựa trên dữ liệu người dùng nhập vào.
2.  **Performance Summary Tool:** Một công cụ an toàn để agent có thể tự truy vấn cơ sở dữ liệu PostgreSQL và lấy dữ liệu hiệu suất tổng hợp (tổng chi tiêu, doanh số, clicks, orders) cho một ASIN cụ thể trong một khoảng thời gian.

---

## 4. Chi tiết Triển khai và Hoạt động

### 4.1. Thiết lập & Các "Công cụ" của Agent

1.  **Dependencies:** Các thư viện cần thiết đã được cài đặt vào dự án:
    -   `langchain`, `langgraph`, `@langchain/core`, `@langchain/google-genai`.

2.  **Định nghĩa Tools (trong `backend/services/langchain/tools.js`):**
    -   **`financialsTool`:** Nhận vào các thông tin như giá bán, chi phí sản phẩm, phí FBA... và trả về các chỉ số `profitPerUnit` và `breakEvenAcos`.
    -   **`performanceSummaryTool`:** Nhận vào `asin`, `startDate`, và `endDate`. Nó thực thi một câu lệnh SQL an toàn, có tham số hóa để truy vấn bảng `sponsored_products_search_term_report` và trả về một bản tóm tắt hiệu suất. Tool này không cho phép thực thi SQL tùy ý để đảm bảo an toàn.

### 4.2. "Bộ não" của Agent: Thiết kế với LangGraph

Agent được xây dựng trong file `backend/services/langchain/agent.js` bằng LangGraph.

1.  **Trạng thái của Agent (Agent State):**
    -   Một object được định nghĩa để lưu trữ thông tin qua các bước, bao gồm `userInput`, `financialMetrics`, `performanceData`, `finalResult`, và `error`.

2.  **Các Nút (Nodes) trong Graph:**
    -   **`gatherDataNode`:** Đây là bước đầu tiên. Nó nhận `userInput` từ người dùng, sau đó gọi lần lượt `financialsTool` và `performanceSummaryTool` để thu thập tất cả dữ liệu cần thiết cho việc phân tích.
    -   **`analystAndFormatNode`:** Sau khi có dữ liệu, nút này sẽ tổng hợp mọi thứ, tính toán các chỉ số phái sinh (như ACoS mục tiêu, ACoS tổng thể), và tạo ra một prompt chi tiết cho mô hình Gemini. Nó yêu cầu Gemini phân tích và trả về một rule cùng với lý do đề xuất dưới dạng JSON.

3.  **Các Cạnh (Edges) và Logic Điều hướng:**
    -   Quy trình bắt đầu tại `gatherDataNode`.
    -   Một **cạnh điều kiện (conditional edge)** được sử dụng sau `gatherDataNode`:
        -   **NẾU** thu thập dữ liệu thành công (tìm thấy performance data) → quy trình chuyển đến `analystAndFormatNode`.
        -   **NẾU** không tìm thấy dữ liệu hoặc có lỗi → quy trình kết thúc (`END`) và trả về lỗi cho người dùng.
    -   Sau khi `analystAndFormatNode` chạy xong, quy trình kết thúc.

### 4.3. Tích hợp vào API

-   Endpoint `POST /api/ai/suggest-rule` trong file `backend/routes/ai.js` đã được nâng cấp.
-   Nó giữ lại logic cũ để xử lý các sản phẩm mới (New Product).
-   Đối với các sản phẩm đã có dữ liệu (Existing Product), nó sẽ khởi tạo và thực thi agent LangGraph đã được xây dựng ở trên.
-   Nó nhận kết quả cuối cùng từ `finalState` của agent và trả về cho frontend, bao gồm rule được đề xuất, lý do, và một bản tóm tắt dữ liệu đã được sử dụng.

---

## 5. Ví dụ Quy trình Hoạt động

#### **Kịch bản: Đề xuất Rule Tối ưu hóa**

1.  **Người dùng:** Trên giao diện "AI Suggester", chọn "Sản phẩm có sẵn dữ liệu", nhập ASIN, dữ liệu tài chính, và chọn loại rule là "Điều chỉnh Bid".
2.  **Agent (`gatherDataNode`):**
    -   Gọi `financialsTool` → tính ra ACoS Hòa vốn là 35%.
    -   Gọi `performanceSummaryTool` → tìm thấy dữ liệu tổng hợp cho ASIN trong khoảng thời gian đã chọn (ví dụ: tổng chi tiêu $150, tổng sales $250).
3.  **Edge `dataCheckEdge`:** Thấy có dữ liệu, quyết định chuyển sang bước phân tích.
4.  **Agent (`analystAndFormatNode`):**
    -   Tính toán ACoS tổng thể là 60% ($150 / $250).
    -   Tạo prompt cho Gemini: *"Dưới đây là dữ liệu của một sản phẩm có ACoS Hòa vốn là 35% nhưng ACoS Tổng thể đang là 60%. Hãy tạo một rule 'BID_ADJUSTMENT' để giảm chi tiêu lãng phí và đưa ACoS về gần mức mục tiêu."*
5.  **LLM (Gemini):** Phân tích và trả về một đối tượng JSON chứa rule và lý do.
6.  **API:** Gửi kết quả cuối cùng về cho frontend để hiển thị.

---

## 6. Khả năng Mở rộng trong Tương lai

Kiến trúc agentic này rất dễ mở rộng. Trong tương lai, chúng ta có thể:
-   **Thêm nhiều Tools hơn:** Ví dụ, một tool có thể lấy dữ liệu trực tiếp từ Amazon API, hoặc một tool khác có thể phân tích xu hướng từ Google Trends.
-   **Mở rộng Logic của Agent:** Thêm các nút mới vào graph để thực hiện các tác vụ phức tạp hơn, như tự động tạo báo cáo phân tích hàng tuần và gửi qua email.
-   **Tăng cường khả năng tự quyết định:** Cho phép agent tự quyết định cần chạy tool nào tiếp theo dựa trên kết quả của tool trước đó, tạo ra một quy trình phân tích hoàn toàn động.

Việc tích hợp LangChain và LangGraph đã là một bước nhảy vọt, biến "AI Suggester" từ một công cụ tạo prompt đơn giản thành một trợ lý phân tích PPC tự động và thông minh thực thụ.